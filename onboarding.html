<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App - Setup Your Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .background-wrapper {
            background-color: #000000;
            position: relative;
            overflow: hidden;
        }
        .glow-effect {
            position: absolute;
            width: 800px;
            height: 800px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(134, 25, 143, 0.3) 0%, rgba(76, 29, 149, 0) 60%);
            pointer-events: none;
        }
        .btn-disabled {
            background-color: #1f2937; /* bg-gray-800 */
            color: #6b7280; /* text-gray-500 */
            cursor: not-allowed;
            opacity: 0.6;
        }
        select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="gray" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.5em;
            padding-right: 2.5rem;
        }
        .step { display: none; }
        .step.active { display: block; }
    </style>
</head>
<body class="background-wrapper flex items-center justify-center h-screen text-gray-200">
    <div class="glow-effect"></div>

    <div class="w-full max-w-md p-8 bg-black/60 backdrop-blur-xl border border-gray-700/50 rounded-2xl shadow-2xl z-10">

        <!-- Step 1: Username & Display Name -->
        <div id="step-1" class="step active">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-sky-500">Choose Your Names</h1>
                <p class="mt-2 text-sm text-gray-400">Your username is unique. Your display name is what others will see.</p>
            </div>
            <div class="space-y-6 pt-6">
                <div>
                    <label for="username" class="text-sm font-medium text-gray-400">Username</label>
                    <input id="username" type="text" required autocapitalize="none" class="w-full px-4 py-2 mt-1 text-gray-200 bg-gray-900/70 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    <p id="username-status" class="text-xs mt-1 h-4"></p>
                </div>
                <div>
                    <label for="displayName" class="text-sm font-medium text-gray-400">Display Name</label>
                    <input id="displayName" type="text" required class="w-full px-4 py-2 mt-1 text-gray-200 bg-gray-900/70 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <button id="continue-1" disabled class="w-full px-4 py-3 text-sm font-bold rounded-md shadow-lg transition-all btn-disabled">Continue</button>
            </div>
        </div>

        <!-- Step 2: School, Grad Year, Bio -->
        <div id="step-2" class="step">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-sky-500">Tell Us More</h1>
                <p class="mt-2 text-sm text-gray-400">This helps you connect with classmates.</p>
            </div>
            <div class="space-y-6 pt-6">
                <div>
                    <label for="school" class="text-sm font-medium text-gray-400">School Name</label>
                    <input id="school" type="text" required class="w-full px-4 py-2 mt-1 text-gray-200 bg-gray-900/70 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <div>
                    <label for="gradYear" class="text-sm font-medium text-gray-400">Graduation Year</label>
                    <select id="gradYear" required class="w-full px-4 py-2 mt-1 text-gray-200 bg-gray-900/70 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <option value="" disabled selected>Select Year</option>
                    </select>
                </div>
                 <div>
                    <label for="bio" class="text-sm font-medium text-gray-400">Bio</label>
                    <textarea id="bio" maxlength="100" class="w-full px-4 py-2 mt-1 text-gray-200 bg-gray-900/70 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500" rows="2"></textarea>
                    <p id="bio-char-count" class="text-xs text-right text-gray-500 mt-1">0 / 100</p>
                </div>
                <div class="flex gap-4">
                    <button id="back-2" class="w-full px-4 py-3 text-sm font-bold rounded-md shadow-lg bg-gray-700 hover:bg-gray-600 transition-all">Back</button>
                    <button id="continue-2" disabled class="w-full px-4 py-3 text-sm font-bold rounded-md shadow-lg transition-all btn-disabled">Continue</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Confirmation -->
        <div id="step-3" class="step">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-sky-500">Looks good?</h1>
                <p class="mt-2 text-sm text-gray-400">Confirm your details below.</p>
            </div>
            <div class="space-y-6 pt-6">
                <div class="flex items-center gap-6">
                    <div class="w-24 h-24 flex-shrink-0">
                        <label for="pfp-upload" class="cursor-pointer group">
                            <img id="confirm-pfp-preview" src="" class="w-full h-full rounded-full object-cover border-2 border-fuchsia-500/50 group-hover:border-fuchsia-500 transition">
                            <div id="confirm-pfp-initial" class="w-full h-full rounded-full bg-gradient-to-br from-fuchsia-600 to-purple-600 flex items-center justify-center text-4xl font-bold text-white group-hover:opacity-80 transition"></div>
                        </label>
                        <input type="file" id="pfp-upload" class="hidden" accept="image/png, image/jpeg">
                    </div>
                    <div class="w-full space-y-2 text-sm">
                        <p><strong class="text-gray-400">Username:</strong> <span id="confirm-username"></span></p>
                        <p><strong class="text-gray-400">Display Name:</strong> <span id="confirm-displayName"></span></p>
                        <p><strong class="text-gray-400">School:</strong> <span id="confirm-school"></span></p>
                        <p><strong class="text-gray-400">Grad Year:</strong> <span id="confirm-gradYear"></span></p>
                    </div>
                </div>
                 <div>
                    <p class="text-gray-400 text-sm">Bio:</p>
                    <p id="confirm-bio" class="text-sm mt-1 p-2 bg-gray-900/50 rounded-md min-h-[40px]"></p>
                </div>
                <div class="flex gap-4 pt-2">
                    <button id="back-3" class="w-full px-4 py-3 text-sm font-bold rounded-md shadow-lg bg-gray-700 hover:bg-gray-600 transition-all">Back</button>
                    <button id="continue-3" class="w-full px-4 py-3 text-sm font-bold rounded-md shadow-lg transition-all text-white bg-gradient-to-r from-teal-400 to-sky-500">Finish Setup</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAFA-KDIFkqGmQ2fp9mz0tpwDOzcp_D93A",
            authDomain: "phonechatban.firebaseapp.com",
            projectId: "phonechatban",
            storageBucket: "phonechatban.firebasestorage.app",
            messagingSenderId: "987815128530",
            appId: "1:987815128530:web:4a938c18fd910b8d7bac0b",
            measurementId: "G-DVPM4KQ70Y"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- State Management ---
        let currentUser = null;
        let onboardingData = { profilePictureFile: null };
        let isUsernameAvailable = false;
        let usernameCheckTimeout;

        // --- DOM Elements ---
        const steps = document.querySelectorAll('.step');
        const usernameInput = document.getElementById('username');
        const usernameStatus = document.getElementById('username-status');
        const displayNameInput = document.getElementById('displayName');
        const schoolInput = document.getElementById('school');
        const gradYearSelect = document.getElementById('gradYear');
        const bioInput = document.getElementById('bio');
        const bioCharCount = document.getElementById('bio-char-count');
        const pfpUploadInput = document.getElementById('pfp-upload');
        const continue1Btn = document.getElementById('continue-1');
        const continue2Btn = document.getElementById('continue-2');
        const continue3Btn = document.getElementById('continue-3');
        const back2Btn = document.getElementById('back-2');
        const back3Btn = document.getElementById('back-3');

        // --- Navigation ---
        function goToStep(stepNumber) {
            steps.forEach(step => step.classList.remove('active'));
            document.getElementById(`step-${stepNumber}`).classList.add('active');
        }

        continue1Btn.addEventListener('click', () => {
            onboardingData.username = usernameInput.value.toLowerCase();
            onboardingData.displayName = displayNameInput.value;
            goToStep(2);
        });
        back2Btn.addEventListener('click', () => goToStep(1));
        continue2Btn.addEventListener('click', () => {
            onboardingData.schoolName = schoolInput.value;
            onboardingData.graduationYear = gradYearSelect.value;
            onboardingData.bio = bioInput.value;
            populateConfirmation();
            goToStep(3);
        });
        back3Btn.addEventListener('click', () => goToStep(2));
        
        // --- Populate Confirmation ---
        function populateConfirmation() {
            document.getElementById('confirm-username').textContent = onboardingData.username;
            document.getElementById('confirm-displayName').textContent = onboardingData.displayName;
            document.getElementById('confirm-school').textContent = onboardingData.schoolName;
            document.getElementById('confirm-gradYear').textContent = onboardingData.graduationYear;
            document.getElementById('confirm-bio').textContent = onboardingData.bio || "No bio yet.";
            
            const pfpInitial = document.getElementById('confirm-pfp-initial');
            pfpInitial.textContent = (onboardingData.displayName || '?').charAt(0).toUpperCase();

            if (!onboardingData.profilePictureFile) {
                pfpInitial.style.display = 'flex';
                document.getElementById('confirm-pfp-preview').style.display = 'none';
            }
        }

        // --- Populate Grad Year ---
        for (let year = 2026; year <= 2038; year++) {
            gradYearSelect.appendChild(new Option(year, year));
        }

        // --- Validation & Button Logic ---
        const btnActiveClasses = "text-white bg-gradient-to-r from-teal-400 to-sky-500";
        const baseButtonClasses = "w-full px-4 py-3 text-sm font-bold rounded-md shadow-lg transition-all";

        async function checkUsername() {
            const username = usernameInput.value.toLowerCase().trim();
            if (username.length < 3 || !/^[a-z0-9_.]+$/.test(username)) {
                usernameStatus.textContent = '3+ chars, lowercase, numbers, _, .';
                usernameStatus.className = 'text-xs mt-1 h-4 text-yellow-500';
                isUsernameAvailable = false;
                validateStep1();
                return;
            }
            usernameStatus.textContent = 'Checking...';
            usernameStatus.className = 'text-xs mt-1 h-4 text-gray-500';
            
            const docRef = doc(db, "usernames", username);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                usernameStatus.textContent = 'Username is taken.';
                usernameStatus.className = 'text-xs mt-1 h-4 text-red-500';
                isUsernameAvailable = false;
            } else {
                usernameStatus.textContent = 'Username is available!';
                usernameStatus.className = 'text-xs mt-1 h-4 text-green-500';
                isUsernameAvailable = true;
            }
            validateStep1();
        }

        function validateStep1() {
            const isDisplayNameValid = displayNameInput.value.trim().length > 0;
            if (isUsernameAvailable && isDisplayNameValid) {
                continue1Btn.disabled = false;
                continue1Btn.className = `${baseButtonClasses} ${btnActiveClasses}`;
            } else {
                continue1Btn.disabled = true;
                continue1Btn.className = `${baseButtonClasses} btn-disabled`;
            }
        }

        function validateStep2() {
            const isSchoolValid = schoolInput.value.trim() !== '';
            const isGradYearValid = gradYearSelect.value !== '';
            if (isSchoolValid && isGradYearValid) {
                continue2Btn.disabled = false;
                continue2Btn.className = `${baseButtonClasses} ${btnActiveClasses}`;
            } else {
                continue2Btn.disabled = true;
                continue2Btn.className = `${baseButtonClasses} btn-disabled`;
            }
        }

        usernameInput.addEventListener('input', () => {
            clearTimeout(usernameCheckTimeout);
            usernameCheckTimeout = setTimeout(checkUsername, 500);
        });
        displayNameInput.addEventListener('input', validateStep1);
        schoolInput.addEventListener('input', validateStep2);
        gradYearSelect.addEventListener('change', validateStep2);
        bioInput.addEventListener('input', () => {
            bioCharCount.textContent = `${bioInput.value.length} / 100`;
        });

        // --- PFP Upload ---
        pfpUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                onboardingData.profilePictureFile = file;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const preview = document.getElementById('confirm-pfp-preview');
                    preview.src = event.target.result;
                    preview.style.display = 'block';
                    document.getElementById('confirm-pfp-initial').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });

        // --- Auth & Final Submission ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
            } else {
                window.location.href = './login.html';
            }
        });

        continue3Btn.addEventListener('click', async () => {
            if (!currentUser) return alert("Error: Not logged in.");
            continue3Btn.disabled = true;
            continue3Btn.textContent = 'Saving...';
            
            try {
                let photoURL = null;
                if (onboardingData.profilePictureFile) {
                    const filePath = `profilePictures/${currentUser.uid}/${onboardingData.profilePictureFile.name}`;
                    const storageRef = ref(storage, filePath);
                    const snapshot = await uploadBytes(storageRef, onboardingData.profilePictureFile);
                    photoURL = await getDownloadURL(snapshot.ref);
                }

                const batch = writeBatch(db);
                
                const userDocRef = doc(db, "users", currentUser.uid);
                batch.set(userDocRef, {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    username: onboardingData.username,
                    displayName: onboardingData.displayName,
                    schoolName: onboardingData.schoolName,
                    graduationYear: onboardingData.graduationYear,
                    bio: onboardingData.bio || '',
                    photoURL: photoURL,
                    createdAt: new Date()
                });

                const usernameDocRef = doc(db, "usernames", onboardingData.username);
                batch.set(usernameDocRef, { uid: currentUser.uid });

                await batch.commit();
                
                window.location.href = './chat.html';

            } catch (error) {
                console.error("Error saving profile: ", error);
                alert("Could not save profile. The username might have been taken. Please go back and try another.");
                continue3Btn.disabled = false;
                continue3Btn.textContent = 'Finish Setup';
            }
        });

    </script>
</body>
</html>
