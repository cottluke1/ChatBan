<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App - Edit Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .background-wrapper { background-color: #000000; position: relative; overflow: hidden; }
        .glow-effect { position: absolute; width: 800px; height: 800px; left: 50%; top: 50%; transform: translate(-50%, -50%); background: radial-gradient(circle, rgba(134, 25, 143, 0.3) 0%, rgba(76, 29, 149, 0) 60%); pointer-events: none; }
        select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="gray" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat; background-position: right 1rem center; background-size: 1.5em; padding-right: 2.5rem;
        }
    </style>
</head>
<body class="background-wrapper flex items-center justify-center h-screen text-gray-200">
    <div class="glow-effect"></div>

    <div class="w-full max-w-lg p-8 bg-black/60 backdrop-blur-xl border border-gray-700/50 rounded-2xl shadow-2xl z-10">
        <div class="flex items-center justify-between mb-6">
            <a href="./chat.html" class="text-sm text-gray-400 hover:text-white">&larr; Back to Chat</a>
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-sky-500">Edit Profile</h1>
        </div>
        
        <div class="space-y-6">
            <div class="flex items-center gap-6">
                <div class="w-24 h-24 flex-shrink-0">
                    <label for="pfp-upload" class="cursor-pointer group relative">
                        <img id="pfp-preview" src="" class="w-full h-full rounded-full object-cover border-2 border-fuchsia-500/50 group-hover:border-fuchsia-500 transition hidden">
                        <div id="pfp-initial" class="w-full h-full rounded-full flex items-center justify-center text-4xl font-bold text-white group-hover:opacity-80 transition"></div>
                        <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </div>
                    </label>
                    <input type="file" id="pfp-upload" class="hidden" accept="image/png, image/jpeg">
                </div>
                <div class="w-full">
                    <p class="text-2xl font-bold" id="display-name-header"></p>
                    <p class="text-sm text-gray-400" id="username-header"></p>
                </div>
            </div>

            <form id="profile-form" class="space-y-4">
                <div>
                    <label for="displayName" class="text-sm font-medium text-gray-400">Display Name</label>
                    <input id="displayName" type="text" required class="w-full px-4 py-2 mt-1 text-gray-200 bg-gray-900/70 border border-gray-700 rounded-md">
                </div>
                <div>
                    <label for="school" class="text-sm font-medium text-gray-400">School Name</label>
                    <input id="school" type="text" required class="w-full px-4 py-2 mt-1 text-gray-200 bg-gray-900/70 border border-gray-700 rounded-md">
                </div>
                <div>
                    <label for="gradYear" class="text-sm font-medium text-gray-400">Graduation Year</label>
                    <select id="gradYear" required class="w-full px-4 py-2 mt-1 text-gray-200 bg-gray-900/70 border border-gray-700 rounded-md"></select>
                </div>
                <div>
                    <label for="bio" class="text-sm font-medium text-gray-400">Bio</label>
                    <textarea id="bio" maxlength="100" class="w-full px-4 py-2 mt-1 text-gray-200 bg-gray-900/70 border border-gray-700 rounded-md" rows="2"></textarea>
                </div>
                 <div>
                    <label class="text-sm font-medium text-gray-400">Theme</label>
                    <div class="flex gap-4 mt-2">
                        <button type="button" id="theme-dark" class="px-4 py-2 rounded-md bg-gray-800 text-white border-2 border-transparent">Dark</button>
                        <button type="button" id="theme-light" class="px-4 py-2 rounded-md bg-gray-300 text-black border-2 border-transparent">Light</button>
                    </div>
                </div>
                <div class="pt-4 flex gap-4">
                    <button id="logout-button" type="button" class="w-full px-4 py-3 text-sm font-bold rounded-md shadow-lg text-white bg-red-600 hover:bg-red-700">Logout</button>
                    <button id="save-button" type="submit" class="w-full px-4 py-3 text-sm font-bold rounded-md shadow-lg text-white bg-gradient-to-r from-teal-400 to-sky-500">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAFA-KDIFkqGmQ2fp9mz0tpwDOzcp_D93A",
            authDomain: "phonechatban.firebaseapp.com",
            projectId: "phonechatban",
            storageBucket: "phonechatban.firebasestorage.app",
            messagingSenderId: "987815128530",
            appId: "1:987815128530:web:4a938c18fd910b8d7bac0b",
            measurementId: "G-DVPM4KQ70Y"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- DOM Elements ---
        const displayNameHeader = document.getElementById('displayName-header');
        const usernameHeader = document.getElementById('username-header');
        const pfpPreview = document.getElementById('pfp-preview');
        const pfpInitial = document.getElementById('pfp-initial');
        const pfpUploadInput = document.getElementById('pfp-upload');
        const form = document.getElementById('profile-form');
        const saveButton = document.getElementById('save-button');
        const logoutButton = document.getElementById('logout-button');
        const themeDarkBtn = document.getElementById('theme-dark');
        const themeLightBtn = document.getElementById('theme-light');

        let currentUser = null;
        let currentUserData = null;
        let newPfpFile = null;

        // --- Populate Grad Year ---
        for (let year = 2026; year <= 2038; year++) {
            form.gradYear.appendChild(new Option(year, year));
        }

        // --- Load User Data ---
        async function loadUserData(userId) {
            const userDocRef = doc(db, "users", userId);
            const docSnap = await getDoc(userDocRef);

            if (docSnap.exists()) {
                currentUserData = docSnap.data();
                displayNameHeader.textContent = currentUserData.displayName;
                usernameHeader.textContent = `@${currentUserData.username}`;
                
                if (currentUserData.photoURL) {
                    pfpPreview.src = currentUserData.photoURL;
                    pfpPreview.classList.remove('hidden');
                    pfpInitial.classList.add('hidden');
                } else {
                    pfpInitial.textContent = (currentUserData.displayName || '?').charAt(0).toUpperCase();
                    pfpInitial.className = `w-full h-full rounded-full flex items-center justify-center text-4xl font-bold text-white group-hover:opacity-80 transition ${currentUserData.pfpColor}`;
                    pfpPreview.classList.add('hidden');
                    pfpInitial.classList.remove('hidden');
                }

                form.displayName.value = currentUserData.displayName;
                form.school.value = currentUserData.schoolName;
                form.gradYear.value = currentUserData.graduationYear;
                form.bio.value = currentUserData.bio || '';
                
                updateThemeUI(currentUserData.theme);
            }
        }

        // --- Theme Switcher ---
        function updateThemeUI(theme) {
            if (theme === 'light') {
                themeLightBtn.classList.add('border-sky-500');
                themeDarkBtn.classList.remove('border-sky-500');
            } else {
                themeDarkBtn.classList.add('border-sky-500');
                themeLightBtn.classList.remove('border-sky-500');
            }
        }
        themeDarkBtn.addEventListener('click', () => updateThemeUI('dark'));
        themeLightBtn.addEventListener('click', () => updateThemeUI('light'));


        // --- PFP Upload ---
        pfpUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                newPfpFile = file;
                const reader = new FileReader();
                reader.onload = (event) => {
                    pfpPreview.src = event.target.result;
                    pfpPreview.classList.remove('hidden');
                    pfpInitial.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // --- Form Submission ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';

            try {
                let photoURL = currentUserData.photoURL;
                if (newPfpFile) {
                    const filePath = `profilePictures/${currentUser.uid}/${newPfpFile.name}`;
                    const storageRef = ref(storage, filePath);
                    const snapshot = await uploadBytes(storageRef, newPfpFile);
                    photoURL = await getDownloadURL(snapshot.ref);
                }

                const userDocRef = doc(db, "users", currentUser.uid);
                await updateDoc(userDocRef, {
                    displayName: form.displayName.value,
                    schoolName: form.school.value,
                    graduationYear: form.gradYear.value,
                    bio: form.bio.value,
                    photoURL: photoURL,
                    theme: themeDarkBtn.classList.contains('border-sky-500') ? 'dark' : 'light'
                });

                saveButton.textContent = 'Saved!';
                setTimeout(() => {
                    saveButton.textContent = 'Save Changes';
                    saveButton.disabled = false;
                }, 2000);

            } catch (error) {
                console.error("Error updating profile:", error);
                alert("Could not save changes. Please try again.");
                saveButton.textContent = 'Save Changes';
                saveButton.disabled = false;
            }
        });
        
        logoutButton.addEventListener('click', () => signOut(auth));

        // --- Auth Observer ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserData(user.uid);
            } else {
                window.location.href = './login.html';
            }
        });

    </script>
</body>
</html>
