<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .background-wrapper {
            background-color: #000000;
            position: relative;
            overflow: hidden;
        }
        .glow-effect {
            position: absolute;
            width: 800px;
            height: 800px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(134, 25, 143, 0.3) 0%, rgba(76, 29, 149, 0) 60%);
            pointer-events: none;
        }
        .btn-disabled {
            background-color: #1f2937; /* bg-gray-800 */
            color: #6b7280; /* text-gray-500 */
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body class="background-wrapper flex items-center justify-center h-screen text-gray-200">
    <div class="glow-effect"></div>

    <div class="w-full max-w-md p-8 space-y-6 bg-black/60 backdrop-blur-xl border border-gray-700/50 rounded-2xl shadow-2xl z-10">

        <!-- Login View -->
        <div id="login-view">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-fuchsia-500 to-purple-500">
                    Welcome Back
                </h1>
                <p class="mt-2 text-sm text-gray-400">Sign in to your account to continue</p>
            </div>
            <form id="login-form" class="space-y-6 pt-6">
                <div>
                    <label for="login-email" class="text-sm font-medium text-gray-400">Email address</label>
                    <input id="login-email" name="email" type="email" autocomplete="email" required
                        class="w-full px-4 py-2 mt-1 text-gray-200 bg-gray-900/70 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                </div>
                <div>
                    <label for="login-password" class="text-sm font-medium text-gray-400">Password</label>
                    <input id="login-password" name="password" type="password" autocomplete="current-password" required
                        class="w-full px-4 py-2 mt-1 text-gray-200 bg-gray-900/70 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                </div>
                <div>
                    <button id="login-button" type="submit" disabled
                        class="w-full px-4 py-3 text-sm font-bold rounded-md shadow-lg transition-all btn-disabled">
                        Sign In
                    </button>
                </div>
            </form>
        </div>

        <!-- Signup View (Initially Hidden) -->
        <div id="signup-view" class="hidden">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-sky-500">
                    Create an Account
                </h1>
                <p class="mt-2 text-sm text-gray-400">Get started with a free account</p>
            </div>
            <form id="signup-form" class="space-y-6 pt-6">
                 <div>
                    <label for="signup-email" class="text-sm font-medium text-gray-400">Email address</label>
                    <input id="signup-email" name="email" type="email" autocomplete="email" required
                        class="w-full px-4 py-2 mt-1 text-gray-200 bg-gray-900/70 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent transition">
                </div>
                <div>
                    <label for="signup-password" class="text-sm font-medium text-gray-400">Create Password</label>
                    <input id="signup-password" name="password" type="password" autocomplete="new-password" required
                        class="w-full px-4 py-2 mt-1 text-gray-200 bg-gray-900/70 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent transition">
                </div>
                <div>
                    <button id="signup-button" type="submit" disabled
                        class="w-full px-4 py-3 text-sm font-bold rounded-md shadow-lg transition-all btn-disabled">
                        Create Account
                    </button>
                </div>
            </form>
        </div>

        <!-- View Switcher -->
        <div class="text-center text-sm text-gray-500 pt-4">
            <span id="switcher-prompt">Don't have an account?</span>
            <button id="switch-button" class="font-bold text-teal-400 hover:underline focus:outline-none">Sign Up</button>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="hidden p-4 text-sm text-center rounded-lg" role="alert">
            <span class="font-medium" id="message-text"></span>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAFA-KDIFkqGmQ2fp9mz0tpwDOzcp_D93A",
            authDomain: "phonechatban.firebaseapp.com",
            projectId: "phonechatban",
            storageBucket: "phonechatban.firebasestorage.app",
            messagingSenderId: "987815128530",
            appId: "1:987815128530:web:4a938c18fd910b8d7bac0b",
            measurementId: "G-DVPM4KQ70Y"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const signupView = document.getElementById('signup-view');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const switchButton = document.getElementById('switch-button');
        const switcherPrompt = document.getElementById('switcher-prompt');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const signupEmail = document.getElementById('signup-email');
        const signupPassword = document.getElementById('signup-password');
        const signupButton = document.getElementById('signup-button');

        // --- Dynamic Button Logic ---
        const baseButtonClasses = "w-full px-4 py-3 text-sm font-bold rounded-md shadow-lg transition-all";
        const loginActiveClasses = "text-white bg-gradient-to-r from-fuchsia-500 to-purple-500 hover:shadow-[0_0_15px_rgba(168,85,247,0.5)]";
        const signupActiveClasses = "text-white bg-gradient-to-r from-teal-400 to-sky-500 hover:shadow-[0_0_15px_rgba(45,212,191,0.5)]";

        function validateEmail(email) {
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        function checkFormValidity(emailInput, passwordInput, button, activeClasses) {
            const isEmailValid = validateEmail(emailInput.value);
            const isPasswordValid = passwordInput.value.length >= 6;

            if (isEmailValid && isPasswordValid) {
                button.disabled = false;
                button.className = `${baseButtonClasses} ${activeClasses}`;
            } else {
                button.disabled = true;
                button.className = `${baseButtonClasses} btn-disabled`;
            }
        }

        loginEmail.addEventListener('input', () => checkFormValidity(loginEmail, loginPassword, loginButton, loginActiveClasses));
        loginPassword.addEventListener('input', () => checkFormValidity(loginEmail, loginPassword, loginButton, loginActiveClasses));
        signupEmail.addEventListener('input', () => checkFormValidity(signupEmail, signupPassword, signupButton, signupActiveClasses));
        signupPassword.addEventListener('input', () => checkFormValidity(signupEmail, signupPassword, signupButton, signupActiveClasses));


        // --- View Switching Logic ---
        switchButton.addEventListener('click', () => {
            const isLoginView = !loginView.classList.contains('hidden');
            if (isLoginView) {
                loginView.classList.add('hidden');
                signupView.classList.remove('hidden');
                switcherPrompt.textContent = "Already have an account?";
                switchButton.textContent = "Sign In";
                switchButton.classList.remove('text-teal-400');
                switchButton.classList.add('text-purple-400');
            } else {
                loginView.classList.remove('hidden');
                signupView.classList.add('hidden');
                switcherPrompt.textContent = "Don't have an account?";
                switchButton.textContent = "Sign Up";
                switchButton.classList.remove('text-purple-400');
                switchButton.classList.add('text-teal-400');
            }
        });

        // --- Functions ---
        function showMessage(message, isError = true) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            if (isError) {
                messageBox.className = 'p-4 text-sm text-center rounded-lg bg-red-900/50 text-red-300 border border-red-500/50';
            } else {
                messageBox.className = 'p-4 text-sm text-center rounded-lg bg-green-900/50 text-green-300 border border-green-500/50';
            }
        }

        // --- Event Listeners for Forms ---
        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (signupButton.disabled) return;
            const email = signupEmail.value;
            const password = signupPassword.value;

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Auth observer will handle redirect.
                })
                .catch((error) => {
                    showMessage(error.message);
                });
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (loginButton.disabled) return;
            const email = loginEmail.value;
            const password = loginPassword.value;

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Auth observer will handle redirect.
                })
                .catch((error) => {
                    showMessage(error.message);
                });
        });

        // --- Auth State Observer ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                getDoc(userDocRef).then(docSnap => {
                    if (docSnap.exists()) {
                        window.location.href = './chat.html';
                    } else {
                        window.location.href = './onboarding.html';
                    }
                }).catch(error => {
                    console.error("Error checking user profile:", error);
                    showMessage("Could not verify your profile. Please try again.");
                });
            }
        });

    </script>
</body>
</html>
